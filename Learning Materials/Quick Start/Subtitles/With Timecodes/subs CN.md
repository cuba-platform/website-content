1
00:00:00,433 --> 00:00:05,199
大家好！欢迎观看《CUBA 平台快速开始》视频介绍。

2
00:00:05,200 --> 00:00:10,366
CUBA 平台是一个基于 Spring 开发的开源框架。

3
00:00:10,366 --> 00:00:15,566
CUBA 的目标是将业务应用系统的开发过程进行流程化。

4
00:00:15,566 --> 00:00:18,899
本集快速开始视频包含以下主题：

5
00:00:19,633 --> 00:00:21,799
数据模型和创建数据库

6
00:00:23,666 --> 00:00:26,566
用户界面开发与定制

7
00:00:29,333 --> 00:00:31,933
业务逻辑实现

8
00:00:36,166 --> 00:00:41,032
作为示例，我们会开发一个简单但是功能完备的应用程序；

9
00:00:41,033 --> 00:00:43,866
该程序可以用来为大会做会议计划。

10
00:00:43,866 --> 00:00:47,799
观看该视频足以使您能开始使用 CUBA 进行开发。

11
00:00:49,133 --> 00:00:53,033
在该视频中，除了使用 CUBA 平台框架之外，

12
00:00:53,033 --> 00:00:57,499
我们还会使用 IntelliJ Idea 的一个插件 - CUBA Studio。

13
00:00:58,900 --> 00:01:04,366
我们来创建一个空的 CUBA 项目，它的命名空间为：planner。

14
00:01:04,366 --> 00:01:08,299
我们将使用 Java 11 作为默认 JDK，

15
00:01:08,300 --> 00:01:10,733
并基于最新的CUBA稳定版。

16
00:01:12,033 --> 00:01:16,099
我们将使用一个内存数据库 - HSQLDB。

17
00:01:16,100 --> 00:01:18,333
对于快速开始的话足够了。

18
00:01:18,333 --> 00:01:21,466
你也可以从下拉列表中选择其他数据库，

19
00:01:21,466 --> 00:01:24,566
先不要修改数据库的连接参数。

20
00:01:25,200 --> 00:01:27,833
项目的名称为 Session Planner。

21
00:01:30,666 --> 00:01:37,699
第一次启动CUBA Studio的时候，它会提示你申请一个CUBA Studio的商业试用版，

22
00:01:37,700 --> 00:01:42,933
免费试用28天，提供一些非常有用的可选的设计器，

23
00:01:42,933 --> 00:01:44,066
我们来开始使用这个商业试用版。

24
00:01:45,700 --> 00:01:51,433
界面的左侧是CUBA项目的导航树。

25
00:01:51,433 --> 00:01:53,699
中间是一个欢迎页面，

26
00:01:53,700 --> 00:01:58,866
你可以通过它快速打开一些CUBA功能、文档、应用市场，

27
00:01:58,866 --> 00:02:02,766
也能看到版本和订阅信息。

28
00:02:02,766 --> 00:02:06,966
界面的右侧是Gradle工具窗口。

29
00:02:06,966 --> 00:02:10,999
CUBA 框架使用 Gradle 作为构建工具。

30
00:02:12,233 --> 00:02:16,533
标准的IntelliJ的构建窗口在下方。

31
00:02:16,533 --> 00:02:20,333
我们可以关闭一些窗口节省屏幕空间。

32
00:02:20,333 --> 00:02:25,966
CUBA主菜单提供了CUBA相关的IDE功能入口。

33
00:02:28,733 --> 00:02:32,866
现在我们要创建带有业务规则的 JPA 类，

34
00:02:32,866 --> 00:02:36,066
比如必要字段、唯一字段和关系。

35
00:02:37,566 --> 00:02:46,099
业务领域模型只有两个类（也称作实体）：Speaker 和 Session（即发言人和会议）。

36
00:02:46,100 --> 00:02:50,933
为了简化开发过程，我们在CUBA Studio提供了可视化编辑器，

37
00:02:50,933 --> 00:02:54,333
使得JPA实体创建更容易。

38
00:02:54,333 --> 00:02:58,899
右键点击 “Data Model” ，然后选择 “New -> Entity” 。

39
00:02:58,900 --> 00:03:01,900
首先，我们需要创建 Speaker 实体，

40
00:03:03,000 --> 00:03:04,966
它有三个字段：

41
00:03:04,966 --> 00:03:07,066
first name（为必须字段），

42
00:03:09,366 --> 00:03:12,332
last name（可选字段）

43
00:03:12,600 --> 00:03:16,833
以及 email（必须且唯一）。

44
00:03:16,833 --> 00:03:20,699
我们还要给 email 字段添加一个校验规则。

45
00:03:20,700 --> 00:03:24,933
CUBA 提供了一个功能，它可以将实体以字符串的形式

46
00:03:24,933 --> 00:03:28,833
展示在 UI 中 - 即 “实例名称（Instance Name）”。

47
00:03:28,833 --> 00:03:32,999
对于 speaker，我们选择姓和名。

48
00:03:33,000 --> 00:03:35,966
我们来详细了解下实体设计器

49
00:03:35,966 --> 00:03:39,566
在Designer标签页旁边会看到生成的文本 - 

50
00:03:39,566 --> 00:03:42,366
一个使用了 JPA 注解的 Java 类。

51
00:03:42,366 --> 00:03:45,132
它们是集成的，所以你可以直接修改文本

52
00:03:45,133 --> 00:03:48,033
然后在Designer中看效果，反过来一样。

53
00:03:48,033 --> 00:03:50,266
你也能看到DDL预览，

54
00:03:50,266 --> 00:03:52,932
需要的话在其中创建索引。

55
00:03:52,933 --> 00:03:56,366
假如我们预见会有很多对 “姓” 的搜索，

56
00:03:56,366 --> 00:04:01,499
为了使搜索更有效率，我们可以对 last name字段添加索引。

57
00:04:08,400 --> 00:04:11,533
接下来，我们创建 Session 实体，

58
00:04:11,533 --> 00:04:14,033
并将它与 Speaker 类关联。

59
00:04:14,033 --> 00:04:18,766
首先，定义一个 Topic 属性 - 必须的字符串类型；

60
00:04:18,766 --> 00:04:22,766
然后，添加 session start - 会议开始时间属性，

61
00:04:22,766 --> 00:04:26,299
然后是 duration - 带有校验规则的持续时长属性。

62
00:04:30,300 --> 00:04:34,366
session end - 会议结束时间是一个计算值，

63
00:04:34,366 --> 00:04:36,266
我们稍后会配置它。

64
00:04:36,266 --> 00:04:39,832
现在，添加一个必须的对 speaker 的引用。

65
00:04:39,833 --> 00:04:41,499
关系为多对一，

66
00:04:41,500 --> 00:04:44,700
我们把关联字段命名为 speaker，

67
00:04:44,700 --> 00:04:48,533
关联 Speaker 类。

68
00:04:48,533 --> 00:04:51,566
此外，我们再创建一个描述字段（description）

69
00:04:51,566 --> 00:04:54,932
用来做会议的长文字描述。

70
00:04:54,933 --> 00:04:59,266
对于实例名称（Instance Name），我们选择topic字段，而不是description字段。

71
00:05:02,500 --> 00:05:08,400
现在我们为session的结束时间创建一个可以自动计算的属性。

72
00:05:12,600 --> 00:05:15,100
首先添加getter方法，

73
00:05:15,100 --> 00:05:18,466
命名为getEndDate，

74
00:05:18,466 --> 00:05:21,966
用 @MetaProperty 注解这个方法。

75
00:05:21,966 --> 00:05:26,332
对于计算属性，需要指定需要加载的属性。

76
00:05:26,333 --> 00:05:29,733
在我们这个例子中，需要加载的是开始时间和持续时间（即startDate 和 duration），

77
00:05:29,733 --> 00:05:32,633
接下来就是添加计算逻辑。

78
00:05:36,133 --> 00:05:38,666
注意这里Studio会高亮这个方法，

79
00:05:38,666 --> 00:05:42,666
因为我们需要给属性指定文本标签，

80
00:05:42,666 --> 00:05:44,699
我们把它加到信息包中。

81
00:05:47,100 --> 00:05:50,100
现在回到设计器看一下。

82
00:05:50,100 --> 00:05:52,866
endDate字段已经加好了，

83
00:05:52,866 --> 00:05:57,299
并且是只读的，相关联的属性也指定了。

84
00:05:57,300 --> 00:05:59,633
现在我们的领域模型已经创建好了。

85
00:06:01,800 --> 00:06:05,433
接下来，我们创建一个简单的界面

86
00:06:05,433 --> 00:06:07,499
对数据库中的表进行 CRUD 操作。

87
00:06:11,066 --> 00:06:15,199
CUBA Studio 带有 UI 界面生成向导，

88
00:06:15,200 --> 00:06:19,000
可以帮我们创建基础却很有用的 UI 界面：

89
00:06:19,000 --> 00:06:23,066
浏览界面 - 在数据网格中展示实体列表

90
00:06:23,066 --> 00:06:30,332
编辑界面 - 使用类似表单的界面编辑一个实体实例

91
00:06:30,333 --> 00:06:34,066
首先，我们创建有关 Speaker 的界面，

92
00:06:34,066 --> 00:06:36,199
由于实体结构非常简单，

93
00:06:36,200 --> 00:06:40,466
在创建界面时我们来直接使用默认参数。

94
00:06:40,466 --> 00:06:44,499
可以看到，每个界面包含了两个部分：

95
00:06:44,500 --> 00:06:48,566
一个 XML 布局，定义了界面的展示形式并带有预览功能；

96
00:06:50,400 --> 00:06:52,533
还有一个控制器类，由 Java 编写，

97
00:06:52,533 --> 00:06:56,533
用来处理界面内部逻辑和事件处理。

98
00:06:56,533 --> 00:06:59,533
现在我们来看下界面布局的结构：

99
00:06:59,533 --> 00:07:01,433
分为两大块。

100
00:07:01,433 --> 00:07:05,533
第一块跟处理数据有关，

101
00:07:05,533 --> 00:07:07,866
第二块是布局，

102
00:07:07,866 --> 00:07:11,366
用来定义界面上组件的位置。

103
00:07:11,366 --> 00:07:14,866
现在我们为sessions创建一个浏览界面和一个编辑界面。

104
00:07:18,766 --> 00:07:22,832
开始之前， 需要先简单介绍一些CUBA相关的概念。

105
00:07:22,833 --> 00:07:28,433
在CUBA平台，实体视图（Entity View）指定了需要从数据库读取哪些字段。

106
00:07:28,433 --> 00:07:33,199
你可以在一个单独的文件里定义view，然后在不同的模块里使用；

107
00:07:33,200 --> 00:07:37,566
也可以在创建界面的时候创建内联的view。

108
00:07:37,566 --> 00:07:40,366
这次我们创建一个内联的view，

109
00:07:40,366 --> 00:07:42,566
只选择必要的数据（字段）。

110
00:07:47,900 --> 00:07:51,666
你会发现相关的字段已经加到界面了。

111
00:07:54,533 --> 00:08:00,133
然后，为新session设置默认的持续时间为1小时。

112
00:08:00,133 --> 00:08:02,433
方法是：在编辑界面

113
00:08:02,433 --> 00:08:07,833
订阅 InitEntity 事件，然后通过代码设置。

114
00:08:12,033 --> 00:08:15,666
接下来，我们需要生成创建数据的脚本。

115
00:08:18,200 --> 00:08:21,233
要生成创建数据库的脚本，

116
00:08:21,233 --> 00:08:25,833
您需要使用 CUBA -> Generate DataBase Scripts 菜单。

117
00:08:25,833 --> 00:08:28,333
要应用这些脚本并创建数据库，

118
00:08:28,333 --> 00:08:30,733
需要使用 CUBA -> Create Database 菜单。

119
00:08:30,733 --> 00:08:32,566
除了我们为应用创建的表，

120
00:08:32,566 --> 00:08:35,932
CUBA 会创建一些系统表，

121
00:08:35,933 --> 00:08:40,466
用来存储用户、角色、任务等信息。

122
00:08:40,466 --> 00:08:44,666
现在我们从 IDE 启动开发模式的应用程序。

123
00:08:47,833 --> 00:08:52,366
只要点击 IDE 的 “Run” 按钮，就可以启动应用程序了。

124
00:08:55,566 --> 00:09:00,132
您会在studio的 “Run” 窗口看到应用程序日志。

125
00:09:00,133 --> 00:09:04,499
等待一会您就可以使用浏览器访问应用了。

126
00:09:04,500 --> 00:09:07,566
我们打开这个 URL 

127
00:09:07,566 --> 00:09:09,732
并使用 “admin” 作为用户名登录系统

128
00:09:09,733 --> 00:09:12,866
默认的密码是 “admin”。

129
00:09:12,866 --> 00:09:15,699
我们在应用程序中添加一些测试数据

130
00:09:15,700 --> 00:09:19,200
首先，添加两个 speaker。

131
00:09:19,200 --> 00:09:22,966
可以看到，email的验证如期生效。

132
00:09:27,533 --> 00:09:30,466
现在为今天和明天各添加一个 Session。

133
00:09:35,433 --> 00:09:38,999
你会看到 endDate 被自动计算出来。

134
00:09:57,666 --> 00:10:01,199
对于基本操作，生成的界面已经很好了。

135
00:10:01,200 --> 00:10:05,400
但是现实中的 UI 通常更加复杂，

136
00:10:05,400 --> 00:10:11,133
我们来在网格视图之外添加一个日历视图，用来浏览会议安排。

137
00:10:11,133 --> 00:10:14,666
对于浏览界面，我们会添加标签页，

138
00:10:14,666 --> 00:10:17,699
在标签页里加上日历，

139
00:10:17,700 --> 00:10:23,300
并提供通过日历组件编辑和重新安排会议的功能。

140
00:10:23,300 --> 00:10:29,066
我们把 sessions 表格放到 session 浏览页面的标签页上，

141
00:10:29,066 --> 00:10:31,299
再添加另一个标签页，

142
00:10:31,300 --> 00:10:34,566
放一个日历控件在上面。

143
00:10:34,566 --> 00:10:40,166
用TabSheet撑满界面，

144
00:10:40,166 --> 00:10:42,632
Studio会要求一个id。

145
00:10:42,633 --> 00:10:47,233
在CUBA中，代码通过ID标识一个界面元素。

146
00:10:47,233 --> 00:10:51,033
我们也需要为每个tab设置id和标题。

147
00:11:06,933 --> 00:11:11,133
修改日历 - 为他分配数据容器然后使它撑满界面。

148
00:11:13,433 --> 00:11:16,899
最后，使Session表格也撑满界面。

149
00:11:16,900 --> 00:11:21,233
在 CUBA 中，UI 组件一般要绑定到实体及其属性上。

150
00:11:21,233 --> 00:11:25,166
我们将日历组件绑定到界面中获取的数据集。

151
00:11:25,166 --> 00:11:28,799
使用搜索域找到属性然后绑定：

152
00:11:28,800 --> 00:11:31,966
startDateProperty 绑定到 session 的开始时间

153
00:11:31,966 --> 00:11:35,299
endDateProperty 绑定到 session 的结束时间

154
00:11:35,300 --> 00:11:38,200
captionProperty 绑定到 session 的主题

155
00:11:38,200 --> 00:11:41,666
descriptionProperty 绑定到 session 的描述

156
00:11:41,666 --> 00:11:45,799
我们让日历只显示工作时间。

157
00:11:48,333 --> 00:11:53,499
除了可视化编辑器，你也可以使用xml编辑器。

158
00:11:53,500 --> 00:11:55,766
我们来添加导航按钮。

159
00:11:58,433 --> 00:12:01,299
我们可以重新打开表单来查看变化 - 

160
00:12:01,300 --> 00:12:05,000
CUBA框架支持界面热部署。

161
00:12:05,000 --> 00:12:09,766
现在我们会看到 session 都在日历上显示了。

162
00:12:09,766 --> 00:12:13,166
现在我们来实现在日历中点击一个事件时，

163
00:12:13,166 --> 00:12:16,799
调用 session 的编辑界面。

164
00:12:16,800 --> 00:12:19,866
当我们与 UI 交互时，会产生交互事件。

165
00:12:19,866 --> 00:12:23,266
我们可以订阅这些事件并进行处理。

166
00:12:23,266 --> 00:12:25,466
我们来处理一下日历条目的点击事件。

167
00:12:28,400 --> 00:12:32,166
我们需要使用编辑界面来修改session的属性。

168
00:12:32,166 --> 00:12:34,932
我们来用EditorScreenFacet，

169
00:12:34,933 --> 00:12:39,399
这是一个用来预先配置编辑界面的组件。

170
00:12:39,400 --> 00:12:43,400
把它放在组件树窗口的window元素下，

171
00:12:43,400 --> 00:12:46,166
设置以下属性：

172
00:12:46,166 --> 00:12:48,499
ID

173
00:12:48,500 --> 00:12:51,100
我们在为session类创建编辑界面。

174
00:12:51,100 --> 00:12:56,733
所以设置实体类 - session 还有相关的数据容器。

175
00:12:56,733 --> 00:12:59,533
界面类 - SessionEdit

176
00:12:59,533 --> 00:13:01,899
设置编辑模式（edit mode）

177
00:13:01,900 --> 00:13:05,433
界面会以dialog模式打开

178
00:13:05,433 --> 00:13:07,533
回到事件处理器。

179
00:13:07,533 --> 00:13:11,166
Inject EditorScreenFacet，

180
00:13:11,166 --> 00:13:15,832
传入事件中指定的被编辑的session实体。

181
00:13:15,833 --> 00:13:18,699
然后我们就可以展示编辑界面了。

182
00:13:18,700 --> 00:13:22,633
我们来重新打开界面，调用编辑界面。

183
00:13:22,633 --> 00:13:26,733
如您所见，为了使 session 编辑对话框更好看些，

184
00:13:26,733 --> 00:13:30,199
我们需要对宽度和高度进行微调。

185
00:13:30,200 --> 00:13:34,800
最简单的方法是把宽度和高度都设置为“auto”。

186
00:13:39,500 --> 00:13:43,000
我们重新打开界面看看改动。

187
00:13:47,500 --> 00:13:51,133
现在该为我们的应用程序添加一些业务逻辑了。

188
00:13:51,133 --> 00:13:54,666
这一节我们将用 CUBA Studio 创建一个服务

189
00:13:54,666 --> 00:13:56,399
用来实现业务逻辑，

190
00:13:56,400 --> 00:13:59,000
然后在界面控制器中使用它。

191
00:13:59,000 --> 00:14:01,500
这个服务将用来重新安排会议，

192
00:14:01,500 --> 00:14:05,800
并保证一个 speaker 不会在同一天内有两个以上的会议。

193
00:14:05,800 --> 00:14:09,366
右键点击 CUBA 项目树的 service 节点，

194
00:14:09,366 --> 00:14:12,132
创建 SessionService 接口

195
00:14:12,133 --> 00:14:14,899
和 SessionServiceBean 实现。

196
00:14:14,900 --> 00:14:17,200
在接口内创建一个方法

197
00:14:17,200 --> 00:14:19,200
然后在 ServiceBean 中实现它。

198
00:14:19,200 --> 00:14:21,133
该方法接受一个 session 参数

199
00:14:21,133 --> 00:14:23,533
和一个新的 session 时间，

200
00:14:23,533 --> 00:14:26,733
然后返回修改的 Session 实例。

201
00:14:29,166 --> 00:14:34,166
首先，计算会议的开始和结束时间。

202
00:14:43,633 --> 00:14:46,699
我们将会使用 CUBA 的 API 来访问数据 -

203
00:14:46,700 --> 00:14:48,333
DataManager 类。

204
00:14:48,333 --> 00:14:51,899
使用 DataManager 我们创建一个 JPQL 查询语句

205
00:14:51,900 --> 00:14:56,800
来检查在指定的时间段内是否有为 Speaker 安排的会议，

206
00:14:56,800 --> 00:14:58,766
并且添加参数值。

207
00:15:08,600 --> 00:15:10,833
然后我们检查查询结果，

208
00:15:10,833 --> 00:15:12,099
依据查询结果，

209
00:15:12,100 --> 00:15:14,600
我们为会议设置新的开始日期

210
00:15:14,600 --> 00:15:18,900
或者直接返回原session实例。

211
00:15:18,900 --> 00:15:20,200
service已经写好了

212
00:15:20,200 --> 00:15:22,700
现在我们把它加到session浏览界面。

213
00:15:22,700 --> 00:15:26,866
这个服务会在日期的拖拽事件中调用。

214
00:15:26,866 --> 00:15:30,099
在订阅拖拽事件的方法中，

215
00:15:30,100 --> 00:15:33,333
我们添加一些代码用来从日历事件中抽取 session 实体，

216
00:15:33,333 --> 00:15:36,166
然后调用服务

217
00:15:36,166 --> 00:15:37,399
来重新计划 session。

218
00:15:41,933 --> 00:15:46,466
然后，我们直接在浏览界面的data container中更新对应的session。

219
00:15:48,366 --> 00:15:50,932
为了部署新的service，

220
00:15:50,933 --> 00:15:52,833
我们需要重启应用程序。

221
00:15:56,100 --> 00:15:59,100
重启之后，打开会议日历，

222
00:15:59,100 --> 00:16:04,566
搞定！我们的日历有通过拖拽重新安排会议的功能了！

223
00:16:04,566 --> 00:16:05,932
我们来看看能否正常运行，

224
00:16:05,933 --> 00:16:07,833
再添加两个额外的会议，

225
00:16:19,466 --> 00:16:23,766
然后尝试把其中一个重新计划到日程已满的一天。

226
00:16:28,566 --> 00:16:32,632
在这节中，我们将会对应用程序的默认标题做自定义修改，

227
00:16:32,633 --> 00:16:34,199
添加一些品牌信息。

228
00:16:35,533 --> 00:16:40,666
在 CUBA 中，您可以修改资源文件并且重写默认的标准文字。

229
00:16:40,666 --> 00:16:44,966
根据应用程序的业务领域我们修改标题为 - 

230
00:16:44,966 --> 00:16:45,999
conference planning （即大会计划）。

231
00:16:48,666 --> 00:16:51,199
得益于 CUBA 的热部署功能，

232
00:16:51,200 --> 00:16:55,200
我们重新登录应用程序即可看到变化。

233
00:16:57,866 --> 00:17:00,499
CUBA 框架还有一个应用市场

234
00:17:00,500 --> 00:17:02,233
里面有很多组件，

235
00:17:02,233 --> 00:17:04,699
这样您可以非常方便的添加有用的功能，

236
00:17:04,700 --> 00:17:08,533
比如为已有的应用程序添加图表或地图支持。

237
00:17:08,533 --> 00:17:11,766
可以通过 Studio 的 “Marketplace” 菜单

238
00:17:11,766 --> 00:17:13,266
直接安装这些组件。

239
00:17:13,266 --> 00:17:15,199
我们来添加Helium扩展。

240
00:17:15,200 --> 00:17:19,200
这是一个新的样式主题，你可以用它替换标准主题

241
00:17:19,200 --> 00:17:22,633
点击安装然后应用就可以了。

242
00:17:22,633 --> 00:17:27,333
现在我们停止程序，运行组件的init脚本。

243
00:17:29,700 --> 00:17:31,133
运行程序，

244
00:17:33,700 --> 00:17:35,633
打开设置界面。

245
00:17:36,633 --> 00:17:39,733
你能在下拉框看到新添加的主题，

246
00:17:39,733 --> 00:17:41,633
选择它然后应用。

247
00:17:42,333 --> 00:17:46,566
重新登录系统 - 新主题就生效了。

248
00:17:46,566 --> 00:17:51,799
你也可以打开主题设置界面，修改它，并且预览你的改动。

249
00:17:57,933 --> 00:18:01,866
CUBA 框架提供很多有用的 API，

250
00:18:01,866 --> 00:18:04,666
能帮您快速的创建业务系统。

251
00:18:04,666 --> 00:18:08,166
这个快速开始视频只演示了最基本的 CUBA 框架

252
00:18:08,166 --> 00:18:09,832
和 CUBA Studio 功能。

253
00:18:09,833 --> 00:18:11,999
访问我们的网站 cuba-platform.cn 

254
00:18:12,000 --> 00:18:15,366
您能找到更多的示例和向导。

255
00:18:16,633 --> 00:18:18,133
感谢观看！