##  

Привет! Это видео поможет вам быстро освоить базовые навыки для работы с платформой CUBA.

CUBA - это фреймворк с открытым кодом, основанный на хорошо знакомом всем фреймворке Spring.

Цель создания фреймворка - унификация процессов разработки корпоративных приложений.

В этом видео мы рассмотрим следующие темы:

* Создание модели данных и базы данных
* Разработка и изменение пользовательского интерфейса
* Создание бизнес логики

В качестве примера мы разработаем простое, но полнофункциональное приложение для планирования докладов на конференции. 

Этого будет достаточно для того, чтобы начать создавать свои собственные приложения с использованием фреймворка CUBA.

Для того, чтобы повторить все, что показано в этом видео, нужно установить плагин для IntelliJ IDEA - CUBA студию. 

## 

Создадим пустой CUBA проект с пространством имен - planner. Будем использовать JDK 11 и последнюю стабильную версию CUBA.

Будем использовать базу данных HSQLDB, указанную по умолчанию. Вы можете выбрать другую базу данных из раскрывающегося списка. Параметры подключения оставим без изменения.
Назовем проект “Планировщик докладов”.

После первого запуска студия предлагает активировать пробный период коммерческой подписки, который составляет 28 дней. После активации нам будут доступны дополнительные графические дизайнеры, которые упростят разработку приложения. Активируем подписку.

Сначала посмотрим на интерфейс студии. Слева находится дерево CUBA-проекта. В центре стартовая страница с быстрым доступом к некоторым функциям CUBA Studio, документации, магазину компонентов, а также информацией о версиях и подписке.

В правой части экрана находится окно Gradle. CUBA использует этот инструмент для сборки и запуска приложения.

Внизу располагается стандартное окно сборки проекта. Закроем некоторые окна, чтобы освободить место на экране. Главное меню CUBA дает быстрый доступ к CUBA-специфичным функциям среды разработки.

## 

Давайте создадим JPA классы и ограничения целостности: обязательность полей, уникальные и внешние ключи. 

В модели данных будет только две сущности: Докладчик и Доклад. 

Для упрощения процесса разработки мы добавили в CUBA студию визуальный дизайнер для создания JPA классов. Правым кликом мыши на узле “Data Model” в дереве вызовем меню создания сущности.

Сперва создадим сущность Докладчик. В ней будет три поля: имя (обязательное), фамилия (необязательное) и электронная почта (обязательное и уникальное). Для контроля правильности ввода на поле электронной почты мы добавим проверку. 

В CUBA мы можем задать способ представления сущностей в текстовом формате для правильного отображения данных в пользовательском интерфейсе - имя экземпляра сущности. Для отображения докладчика мы выберем поля “Имя” и “Фамилия”. 

Посмотрим на дизайнер сущностей. Рядом с визуальным редактором на вкладке Текст мы увидим, что создали обычный класс с JPA аннотациями. Можно исправить код в текстовом редакторе, визуальный редактор отобразит эти изменения. 

Кроме того, можно посмотреть оператор DDL для создания таблицы на вкладке Preview и, если необходимо, добавить индексы. Например, мы ожидаем много поисков по фамилии. Чтобы сделать поиск более эффективным, добавим индекс для фамилии. 

Давайте пойдем дальше. Создадим сущность Доклад и соединим ее с Докладчиком.

Создадим обязательное строковое поле - “Тема”. После этого добавим дату и время начала доклада. Далее добавим длительность  доклада и проверку для этого поля. Время окончания доклада будет вычисляемым, определим его позже.

Теперь сделаем ссылку на докладчика. Это отношение - многие-к-одному, так что сделаем поле-ассоциацию, назовем его “докладчик”, а тип данных - ссылка на класс “Докладчик”.

В дополнение, создадим поле “описание”, в котором будет содержаться краткое описание доклада. Для отображения сущности в интерфейсе выберем поле Тема вместо Описания.

## 


Пришло время сделать вычисляемое поле - окончание доклада. Создадим геттер и назовем его getEndDate, поставим аннотацию @MetaProperty. Для вычисляемого атрибута нужно определить поля, которые будут загружаться - начало доклада и длительность. Затем напишем алгоритм вычисления времени окончания доклада. 

Обратите внимание, что студия подсвечивает метод, потому что нужно определить текст атрибута для отображения на экранах. Пропишем его в появившемся окне.

Вернемся в дизайнер. Видим, что поле окончания доклада добавлено, оно доступно только для чтения и связанные атрибуты определены. 

Доменная модель создана. Теперь можно заняться созданием экранов для выполнения базовых операций над данными приложения. 

## 


В CUBA студии есть генератор для создания пользовательского интерфейса. Мы создадим простые, но полезные экраны: 

* Браузер - для просмотра данных в табличной форме
* Редактор - для редактирования одной строки данных

Создадим экраны для работы с докладчиками. Сущность “Докладчик” довольно простая, поэтому просто оставим значения по умолчанию для генерации.

Можно видеть, что каждый экран состоит из дескриптора - файла с разметкой в формате XML, который отвечает за расположение элементов на экране, и  контроллера, написанного на Java, который отвечает за обработку событий.

Обратим внимание на разметку в XML-файле: здесь два основных блока.  Первый определяет, как данные извлекаются из базы данных. Второй определяет позиции компонентов на экране. 

Теперь создадим браузер и редактор для работы с докладами. Здесь надо немного остановиться и объяснить, как работает CUBA.

Поговорим о представлениях. В CUBA “представление” определяет то, значения каких полей сущности извлекаются из базы данных.  Создавать представления можно либо в отдельных файлах, чтобы затем использовать в разных модулях приложения, либо при создании экранов.

В нашем примере мы определим представление при создании экрана, просто выбрав нужные данные.
Заметим, что нужные столбцы добавлены на экраны.

И определим длительность доклада по умолчанию - 1 час. Для этого подпишемся на событие InitEntity и пропишем значение в коде.

Теперь можем заняться генерацией скриптов и созданием базы данных.

## 


Для генерации скриптов создания базы данных нужно выбрать меню CUBA - Generate Database Scripts
Чтобы выполнить эти скрипты и создать базу, нажмите кнопку Create database.

Помимо таблиц приложения, CUBA создает системные таблицы для хранения информации о пользователях, ролях, задачах и т.д.

Теперь мы можем запустить приложение локально из среды разработки. 

## 

Просто нажмите кнопку запуска в меню среды разработки. В окне Run можно посмотреть лог приложения. Через некоторое время можно будет открыть приложение в браузере. Откройте ссылку, имя пользователя по умолчанию “admin”, пароль - “admin”.

Добавим тестовые данные: пару докладчиков и пару докладов. Как видите, проверка формата электронной почты работает. 

Добавим пару докладов на сегодня. Видим, что дата и время окончания доклада вычисляются автоматически.

Сгенерированные экраны хороши для простых операций, но в реальности пользовательский интерфейс обычно сложнее. Давайте добавим календарь для отображения докладов. 

## 

Далее мы добавим лист с закладками на браузер, добавим закладку с календарем и обеспечим выполнение операций с докладами с использованием календаря.

Поместим таблицу с докладами на лист с закладками, добавим еще одну закладку и поместим на нее календарь.

Развернем лист с закладками на весь экран. Студия запрашивает id для элемента. ID в CUBA нужны, чтобы потом элемент экрана можно было ссылаться в коде приложения.

Добавим ID и заголовок для каждой закладки.

Назначим календарю коллекцию данных и развернем на всю площадь закладки.

Наконец, развернем таблицу с докладами.

В CUBA компоненты экрана могут быть привязаны к сущностям и их полям.  

Мы свяжем календарь с коллекцией данных, извлекаемых из базы. Используем поле поиска и свяжем свойства:

* startDateProperty с датой начала доклада
* endDateProperty с датой окончания доклада
* captionProperty с темой доклада
* И descriptionProperty с описанием доклада

В календаре будем показывать только рабочие часы.

Мы можем использовать не только визуальный редактор экрана, но и редактор XML. Покажем кнопки навигации в календаре.

Можно просто закрыть и открыть экран, чтобы увидеть изменения. Платформа CUBA поддерживает перегрузку пользовательского интерфейса без остановки приложения. Теперь мы видим календарь и доклады. 

## 

Давайте будем вызывать редактор доклада при выборе доклада на календаре.

Когда мы взаимодействуем с интерфейсом, генерируются специальные события. Можно подписаться на эти события и реагировать на происходящее. Давайте подпишемся на клик мыши по докладу в календаре.

Нам нужно вызвать редактор. Будем использовать невизуальный элемент - фасет, который  дает возможность предварительной настройки экрана редактора.

Перетащим фасет на дерево компонентов и определим свойства:

* ID
* Нам нужен редактор докладов. Выберем соответствующий класс и контейнер данных.
* Класс экрана - SessionEdit
* Установим режим редактирования для экрана.
* Открывать редактор будем в виде диалогового окна. 

Вернемся в контроллер и добавим фасет. В редакторе мы будем использовать доклад, который пользователь выбирает щелчком мыши. После этого показываем экран редактора.

Переоткроем браузер и посмотрим на то, что получилось. 

Как видите, нужно немного исправить размеры редактора. Изменим высоту и ширину окна. Самый простой способ - установить значения авто.

Открываем экран заново, и видим, что его размеры изменились. 

А теперь давайте добавим бизнес-логику в наше приложение. 

## 

Мы создадим сервис, который реализует бизнес-логику, и используем его в экране. Это будет сервис для изменения расписания докладов, который будет проверять, что у докладчика в день не более двух докладов.

Правой кнопкой мыши щелкнем на узле “Сервисы” в дереве CUBA проекта и создадим интерфейс SessionService и реализацию SessionServiceBean. Метод сервиса будет принимать доклад и новое время начала, а результатом выполнения будет измененный доклад.

Сначала вычислим время начала и окончания доклада в день, когда запланирован доклад.

Для доступа к данным будем использовать класс DataManager. Добавим его в сервис и используем в методе.

Создадим запрос к базе данных, который проверит, что для заданного докладчика не запланировано других докладов в заданном промежутке времени и передадим в него параметры метода.

Затем проверим результат выполнения запроса и, в зависимости от него, или обновим доклад, присвоив новую дату начала, или вернем исходный доклад.

##

Сервис готов, давайте добавим его в браузер докладов. Будем его вызывать при перетаскивании доклада в календаре. 

В методе-обработчике события календаря добавим код, чтобы извлечь доклад из сгенерированного события и вызовем сервис для переноса доклада. 

Поле этого просто обновим доклад в коллекции данных.

Чтобы запустить сервис, нужно перезапустить приложение. 

После перезапуска открываем календарь докладов и - вуаля! Теперь можем переносить доклады при помощи мыши прямо в календаре. Проверим, как это работает, для этого добавим два доклада для одного докладчика на один день и убедимся, что не сможем назначить ему дополнительный доклад на этот день. 

## 

В этом разделе мы изменим стандартные надписи на экранах приложения. 

В CUBA можно обновлять ресурсы приложения, меняя тем самым текст на стандартных экранах. Давайте поменяем надписи, чтобы они соответствовали назначению нашего приложения - управление докладами.

Поскольку CUBA может перегружать экраны на ходу, просто выйдем из приложения и зайдем в него и увидим, что стандартные надписи поменялись.

## 

Вместе с фреймворком CUBA предоставляется каталог дополнений, в котором есть довольно много модулей для разных полезных вещей, вроде поддержки картографии, отчетности или рисования графиков. Эти компоненты можно легко добавить в приложение.

Можно использовать меню CUBA студии, чтобы установить компоненты.

Давайте добавим компонент Helium. Это новая визуальная тема, которую можно использовать вместо стандартных тем. Нажимаем Install и применяем изменения. 

Теперь нужно остановить приложение и выполнить скрипты компонента. 

Запустим проект и перейдем к настройкам. Добавленная тема появилась в списке. Выберем ее, сохраним изменения и перелогинимся. Тема уже применилась. В окне настроек темы можно предварительно посмотреть, как будут выглядеть изменения.

## 

Платформа CUBA предоставляет большое количество функциональности, чтобы помочь вам сделать бизнес-приложения быстро и качественно. 

В этом видео мы рассмотрели только базовые вещи. 

На нашем сайте cuba-platform.ru можно найти намного больше примеров и учебников, которые помогут вам глубже освоить возможности CUBA. 

Спасибо за внимание!
