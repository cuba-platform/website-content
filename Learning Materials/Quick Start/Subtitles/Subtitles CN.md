## 快速开始 

大家好！欢迎观看《CUBA 平台快速开始》视频介绍。
  
CUBA 平台是一个基于 Spring 开发的开源框架。
  
CUBA 的目标是将业务应用系统的开发过程进行流程化。
  
本集快速开始视频包含以下主题：

* 数据模型和创建数据库
* 用户界面开发与定制
* 业务逻辑实现

作为示例，我们会开发一个简单但是功能完备的应用程序；该程序可以用来为大会做会议计划。

观看该视频足以使您能开始使用 CUBA 进行开发。

在该视频中，除了使用 CUBA 平台框架之外，我们还会使用 IntelliJ Idea 的一个插件 - CUBA Studio。

## 创建项目

我们来创建一个空的 CUBA 项目，它的命名空间为：planner。我们将使用 Java 11 作为默认 JDK，并基于最新的CUBA稳定版。

我们将使用一个内存数据库 - HSQLDB。对于快速开始的话足够了。你也可以从下拉列表中选择其他数据库，先不要修改数据库的连接参数。

项目的名称为 Session Planner。

第一次启动CUBA Studio的时候，它会提示你申请一个CUBA Studio的商业试用版，免费试用28天，提供一些非常有用的可选的设计器，我们来开始使用这个商业试用版。

界面的左侧是CUBA项目的导航树。中间是一个欢迎页面，你可以通过它快速打开一些CUBA功能、文档、应用市场，也能看到版本和订阅信息。

界面的右侧是Gradle工具窗口。CUBA 框架使用 Gradle 作为构建工具。

标准的IntelliJ的构建窗口在下方。我们可以关闭一些窗口节省屏幕空间。CUBA主菜单提供了CUBA相关的IDE功能入口。

## 创建数据模型

现在我们要创建带有业务规则的 JPA 类，比如必要字段、唯一字段和关系。
  
业务领域模型只有两个类（也称作实体）：Speaker 和 Session（发言人和会议）。

为了简化开发过程，我们在CUBA Studio提供了可视化编辑器，使得JPA实体创建更容易。右键点击 “Data Model” ，然后选择 “New -> Entity” 。

首先，我们需要创建 Speaker 实体，它有三个字段：first name（必须），last name（可选），以及 email（必须且唯一）。我们还要给 email 字段添加一个校验规则。

CUBA 提供了一个功能，它可以将实体以字符串的形式展示在 UI 中 - “实例名称（Instance Name）”。对于 speaker，我们选择姓和名。

我们来详细了解下实体设计器。在Designer标签页旁边会看到生成的文本 - 一个使用了 JPA 注解的 Java 类。它们是集成的，所以你可以直接修改文本然后在Designer中看效果，反过来一样。你也能看到DDL预览，需要的话在其中创建索引。

假如我们预见会有很多对 “姓” 的搜索，为了使搜索更有效率，我们可以对 last name字段添加索引。

接下来，我们创建 Session 实体，并将它与 Speaker 类关联。首先，定义一个 Topic 属性 - 必须的字符串类型； 然后，添加 session start - 会议开始时间属性，然后是 duration - 带有校验规则的持续时长属性。session end - 会议结束时间是一个计算值，我们稍后会配置它。

现在，添加一个必须的对 speaker 的引用。关系为多对一，我们把关联字段命名为 speaker，关联 Speaker 类。
 
此外，我们再创建一个描述字段（description）用来做会议的长文字描述。对于实例名称（Instance Name），我们选择topic字段，而不是description字段。

## 创建计算属性

现在我们为session的结束时间创建一个可以自动计算的属性。首先添加getter方法，命名为getEndDate，用 @MetaProperty 注解这个方法。对于计算属性，需要指定需要加载的属性。在我们这个例子中，需要加载的是开始时间和持续时间（startDate 和 duration），接下来就是添加计算逻辑。

注意这里Studio会高亮这个方法，因为我们需要给属性指定文本标签，我们把它加到信息包中。

现在回到设计器看一下。endDate字段已经加好了，并且是只读的，相关联的属性也指定了。

现在我们的领域模型已经创建好了。接下来，我们创建一个简单的界面对数据库中的表进行 CRUD 操作。

## 生成CRUD界面

CUBA Studio 带有 UI 界面生成向导，可以帮我们创建基础却很有用的 UI 界面：

* 浏览界面 - 在数据网格中展示实体列表
* 编辑界面 - 使用类似表单的界面编辑一个实体实例

首先，我们创建有关 Speaker 的界面，由于实体结构非常简单，在创建界面时我们来直接使用默认参数。

可以看到，每个界面包含了两个部分：一个 XML 布局，定义了界面的展示形式并带有预览功能；还有一个控制器类，由 Java 编写，用来处理界面内部逻辑和事件处理。

现在我们来看下界面布局的结构：分为两大块。第一块跟处理数据有关，第二块是布局，用来定义界面上组件的位置。

现在我们为sessions创建一个浏览界面和一个编辑界面。开始之前， 需要先简单介绍一些CUBA相关的概念。

在CUBA平台，实体视图（Entity View）指定了需要从数据库读取哪些字段。你可以在一个单独的文件里定义view，然后在不同的模块里使用；也可以在创建界面的时候创建内联的view。

这次我们创建一个内联的view，只选择必要的数据（字段）。

你会发现相关的字段已经加到界面了。

然后，为新session设置默认的持续时间为1小时。方法是：在编辑界面订阅 InitEntity 事件，然后通过代码设置。

接下来，我们需要生成创建数据的脚本。

## 创建数据库

要生成创建数据库的脚本，您需要使用 CUBA -> Generate DataBase Scripts 菜单。

要应用这些脚本并创建数据库，需要使用 CUBA -> Create Database 菜单。除了我们为应用创建的表，CUBA 会创建一些系统表，用来存储用户、角色、任务等信息。

## 运行开发模式的应用程序

现在我们从 IDE 启动开发模式的应用程序。

只要点击 IDE 的 “Run” 按钮，就可以启动应用程序了。您会在studio的 “Run” 窗口看到应用程序日志。等待一会您就可以使用浏览器访问应用了。我们打开这个 URL 并使用 “admin” 作为用户名登录系统，默认的密码是 “admin”。

我们在应用程序中添加一些测试数据：首先，添加两个 speaker。

可以看到，email的验证如期生效。

现在为今天和明天各添加一个 Session。你会看到 endDate 被自动计算出来。

对于基本操作，生成的界面已经很好了。但是现实中的 UI 通常更加复杂，我们来在网格视图之外添加一个日历视图，用来浏览会议安排。

## 定制用户界面

对于浏览界面，我们会添加标签页，在标签页里加上日历，并提供通过日历组件编辑和重新安排会议的功能。

我们把 sessions 表格放到 session 浏览页面的标签页上，再添加另一个标签页，放一个日历控件在上面。

用TabSheet撑满界面，Studio会要求一个id。在CUBA中，代码通过ID标识一个界面元素。

我们也需要为每个tab设置id和标题。

修改日历 - 为他分配数据容器然后使它撑满界面。

最后，使Session表格也撑满界面。

在 CUBA 中，UI 组件一般要绑定到实体及其属性上。

我们将日历组件绑定到界面中获取的数据集。使用搜索域找到属性然后绑定：

* startDateProperty 绑定到 session 的开始时间
* endDateProperty 绑定到 session 的结束时间
* captionProperty 绑定到 session 的主题
* descriptionProperty 绑定到 session 的描述

我们让日历只显示工作时间。

除了可视化编辑器，你也可以使用xml编辑器。我们来添加导航按钮。

我们可以重新打开表单来查看变化 - CUBA框架支持界面热部署。现在我们会看到 session 都在日历上显示了。

## 使用界面API

现在我们来实现在日历中点击一个事件时，调用 session 的编辑界面。

当我们与 UI 交互时，会产生交互事件。我们可以订阅这些事件并进行处理。我们来处理一下日历条目的点击事件。

我们需要使用编辑界面来修改session的属性。我们来用EditorScreenFacet， 这是一个用来预先配置编辑界面的组件。

把它放在组件树窗口的window元素下，设置以下属性：

* ID
* 我们在为session类创建编辑界面。所以设置实体类 - session 还有相关的数据容器。
* 界面类 - SessionEdit
* 设置编辑模式（edit mode）
* 界面会以dialog模式打开


回到事件处理器。Inject EditorScreenFacet，传入事件中指定的被编辑的session实体。然后我们就可以展示编辑界面了。

我们来重新打开界面，调用编辑界面。

如您所见，为了使 session 编辑对话框更好看些，我们需要对宽度和高度进行微调。最简单的方法是把宽度和高度都设置为“auto”。

我们重新打开界面看看改动。

现在该为我们的应用程序添加一些业务逻辑了。

## 添加业务逻辑

这一节我们将用 CUBA Studio 创建一个服务用来实现业务逻辑，然后在界面控制器中使用它。这个服务将用来重新安排会议，并保证一个 speaker 不会在同一天内有两个以上的会议。

右键点击 CUBA 项目树的 service 节点，创建 SessionService 接口和 SessionServiceBean 实现。在接口内创建一个方法然后在 ServiceBean 中实现它。

该方法接受一个 session 参数和一个新的 session 时间，然后返回修改的 Session 实例。

首先，计算会议的开始和结束时间。

我们将会使用 CUBA 的 API 来访问数据 - DataManager 类。

使用 DataManager 我们创建一个 JPQL 查询语句来检查在指定的时间段内是否有为 Speaker 安排的会议，并且添加参数值。

然后我们检查查询结果，依据查询结果，我们为会议设置新的开始日期或者直接返回原session实例。

## 在界面中使用Service(服务)

service已经写好了，现在我们把它加到session浏览界面。这个服务会在日期的拖拽事件中调用。

在订阅拖拽事件的方法中，我们添加一些代码用来从日历事件中抽取 session 实体，然后调用服务来重新计划 session。然后，我们直接在浏览界面的data container中更新对应的session。

为了部署新的service，我们需要重启应用程序。

重启之后，打开会议日历，搞定！我们的日历有通过拖拽重新安排会议的功能了！我们来看看能否正常运行，再添加两个额外的会议，然后尝试把其中一个重新计划到日程已满的一天。

## 品牌

在这节中，我们将会对应用程序的默认标题做自定义修改，添加一些品牌信息。

在 CUBA 中，您可以修改资源文件并且重写默认的标准文字。根据应用程序的业务领域我们修改标题为 - conference planning （大会计划）。

得益于 CUBA 的热部署功能，我们重新登录应用程序即可看到变化。

## 应用市场

CUBA 框架还有一个应用市场，里面有很多组件，这样您可以非常方便的添加有用的功能，比如为已有的应用程序添加图表或地图支持。

可以通过 Studio 的 “Marketplace” 菜单直接安装这些组件。

我们来添加Helium扩展。这是一个新的样式主题，你可以用它替换标准主题，点击安装然后应用就可以了。

现在我们停止程序，运行组件的init脚本。

运行程序，打开设置界面。你能在下拉框看到新添加的主题，选择它然后应用。重新登录系统 - 新主题就生效了。你也可以打开主题设置界面，修改它，并且预览你的改动。

## 总结

CUBA 框架提供很多有用的 API，能帮您快速的创建业务系统。这个快速开始视频只演示了最基本的 CUBA 框架和 CUBA Studio 功能。

访问我们的网站 cuba-platform.cn 您能找到更多的示例和向导。

感谢观看！

# 应用.标题

快速开始

用于业务应用程序开发的全栈 Java 框架

动力源自

数据模型和数据库创建

用户界面开发

业务逻辑实现

感谢观看